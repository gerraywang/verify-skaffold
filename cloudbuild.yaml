steps:  
  - name: 'gcr.io/k8s-skaffold/skaffold'
    args:
      - skaffold
      - build
      - '--interactive=false'
      - '--default-repo=$_AR_HOSTNAME/$PROJECT_ID/$_PKG_NAME/$REPO_NAME/$_SERVICE_NAME'
      - '--file-output=/workspace/artifacts.json'
      - '--verbosity=debug'
    id: Skaffold-Build

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - '-c'
      - 'cat /workspace/artifacts.json'
    id: Check-Artifacts
    waitFor: ['Skaffold-Build']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - '-c'
      - 'cat /workspace/artifacts.json | jq -r ".buildArtifacts[0].image" > /workspace/image.txt'
    id: Extract-Image
    waitFor: ['Skaffold-Build']

  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        IMAGE=$(cat /workspace/image.txt)
        sed -i "s|image: nginx|image: $IMAGE|g" k8s-deployment.yaml
    id: Replace-Image
    waitFor: ['Extract-Image']

  - name: 'gcr.io/cloud-builders/gcloud'
    id: trigger-deploy
    args: [ "deploy", "releases",  "create",  "release-$SHORT_SHA", "--delivery-pipeline",  "$_SERVICE_NAME", "--region", "asia-northeast1", "--build-artifacts", "artifacts.json" ]
    waitFor: ['Replace-Image']

options:
  substitutionOption: ALLOW_LOOSE
  logging: CLOUD_LOGGING_ONLY